---
title: "ASO xdate error metrics"
author: "Dominik Schneider"
output:
  html_document:
    fig_height: 12
    fig_width: 16
    self_contained: true
    toc: yes
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(cowplot)
library(viridis)
library(broom)
library(viridis)
library(cowplot)
library(RColorBrewer)
library(knitr)
library(stargazer)
library(glmnetUtils)


#must have rprojroot installed from devtools::install_github("krlmlr/rprojroot")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(cache=FALSE,echo=FALSE,message = FALSE,warning=FALSE,error=FALSE,hide=TRUE,results='hide')#,fig.height=12,fig.width=12)
```


```{r params}
ires='500m'
basin='tuo'
pathin='output/xdate-modeling/'
```

```{r functions}
invisible(lapply(dir('lib','.R',full.names=T),source))
source('scripts/functions_modelfitting.R')


r2 <- function(yobs,yhat){
  cor(yobs,yhat,use='complete.obs')^2
}
mae <- function(yobs,yhat){
  mean(abs(yhat-yobs),na.rm=T)
}
pctmae <- function(yobs,yhat){
  mae(yobs,yhat)/mean(yobs,na.rm=T)*100
}
mse <- function(yobs,yhat){
  mean((yhat-yobs)^2,na.rm=T)
}
rmse <- function(yobs,yhat){
  sqrt(mse(yobs,yhat))
}
bias <- function(yobs,yhat){
  mean(yhat-yobs,na.rm=T)
}
pctbias <- function(yobs,yhat){
  bias(yobs,yhat)/mean(yobs,na.rm=T)*100
}
fix_data=function(df,alldata2) {
  mutate(df, simdte=alldata2$dte) #need to add simdate to aug data
}

generate_stats=function(dF){
  dF %>%
  group_by(mdldte,simdte) %>%
  summarise(r2=r2(swe,swehat),
            predmae=mae(swe,swehat),
            rmse=rmse(swe,swehat),
            pctmae=pctmae(swe,swehat),
            pctbias=pctbias(swe,swehat)) %>%
  mutate(simyr=substr(simdte,1,4),
         mdlyr=substr(mdldte,1,4))
}

best_stats <- function(dF){
  dF %>%
    ungroup %>%
    mutate(simyr=substr(simdte,1,4),
           mdlyr=substr(mdldte,1,4)) %>%
    filter(simyr!=mdlyr) %>%
    group_by(simdte,simyr) %>%
    nest() %>%
    mutate(pctmae=map(data,function(dF2){
      dF2 %>% summarise(mdldte=mdldte[which.min(pctmae)],
                        mdlyr=substr(mdldte,1,4),
                        pctmae=min(pctmae),
                        predmae=min(predmae),
                        rmse=min(rmse))
    }),
    pctbias=map(data,function(dF2){
      dF2 %>% summarise(mdldte=mdldte[which.min(abs(pctbias))],
                        mdlyr=substr(mdldte,1,4),
                        pctbias=pctbias[which.min(abs(pctbias))])
    }),
    r2=map(data,function(dF2){
      dF2 %>% summarise(mdldte=mdldte[which.max(r2)],
                        mdlyr=substr(mdldte,1,4),
                        r2=max(r2))
    })
    )
}
```

```{r data}
# forgot to save simulation dates but alldata is saved with every run (both for xdate and splitsample) so use that to add date
alldata=readRDS(paste0(pathin,'alldata_',ires,'.rds'))

phvmdls <- readRDS(paste0(pathin,'phvmdls_augment_',ires,'.rds')) %>%
  mutate(phv_aug_glmmdl=map(phv_aug_glmmdl, fix_data, alldata),
         phvfsca_aug_glmmdl=map(phvfsca_aug_glmmdl, fix_data, alldata)
  )

phvasomdls <- readRDS(paste0(pathin,'asomdls_augment_',ires,'.rds')) %>%
  mutate(phvaso_aug_glmmdl=map(phvaso_aug_glmmdl, fix_data, alldata),
         phvasofsca_aug_glmmdl=map(phvasofsca_aug_glmmdl, fix_data, alldata)
  )

phv <- phvmdls %>% dplyr::select(mdldte,phv_aug_glmmdl) %>% unnest()
phvfsca <- phvmdls %>% dplyr::select(mdldte,phvfsca_aug_glmmdl) %>% unnest()
phvaso <- phvasomdls %>% dplyr::select(mdldte,phvaso_aug_glmmdl) %>% unnest()
phvasofsca <- phvasomdls %>% dplyr::select(mdldte,phvasofsca_aug_glmmdl) %>% unnest()
```

```{r plotfunctions}

statheatmap=function(dF,metricvar){
  ggplot(dF)+
    geom_raster(aes_(x = ~mdldte, y = ~simdte, fill = as.name(metricvar)) )+
    coord_fixed()+
    facet_grid(simyr~mdlyr, scales='free', space='free', as.table=FALSE)+
    # guides(fill=guide_colorbar(reverse = T))+
    theme(axis.text.x=element_text(angle=45,hjust=1))
}

statboxplots=function(dF,metricvar){
  ggplot(dF)+
    geom_boxplot(aes_(x=~simdte,y=as.name(metricvar),fill=~mdlpreds),outlier.size=.5)+
    facet_wrap(~simyr, scales='free_x', as.table=TRUE)+
    # guides(fill=guide_colorbar(reverse = T))+
    theme(axis.text.x=element_text(angle=20,hjust=.8,size=16),
          axis.title.x=element_text(size=18),
          axis.text.y=element_text(size=16),
          axis.title.y=element_text(size=18),
          strip.background=element_blank(),
          strip.text=element_text(face='bold',size=18),
          panel.border=element_rect(size=0.5,linetype='solid',color='grey30'))+
    guides(fill=guide_legend('Model Predictors'))
}

```



```{r results='asis'}
phvstats <- generate_stats(phv) %>% mutate(mdlpreds='phv')
bestphv <- best_stats(phvstats) %>% mutate(mdlpreds='phv')
phvfscastats <- generate_stats(phvfsca) %>% mutate(mdlpreds='phvfsca')
bestphvfsca <- best_stats(phvfscastats) %>% mutate(mdlpreds='phvfsca')
phvasostats <- generate_stats(phvaso) %>% mutate(mdlpreds='phvaso')
bestphvaso <- best_stats(phvasostats) %>% mutate(mdlpreds='phvaso')
phvasofscastats <- generate_stats(phvasofsca) %>% mutate(mdlpreds='phvasofsca')
bestphvasofsca <- best_stats(phvasofscastats) %>% mutate(mdlpreds='phvasofsca')
#
allbeststats <- bind_rows(bestphv,bestphvfsca,bestphvaso,bestphvasofsca) %>%
  mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')))
allstats <- bind_rows(phvstats,phvfscastats,phvasostats,phvasofscastats) %>%
  mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')))

```

# r^2^

```{r best prediction summary}
unnest(allbeststats,r2) %>%
  select(simdte,mdlpreds,r2) %>%
  group_by(mdlpreds) %>%
  summarise(mean(r2),
            median(r2),
            sd(r2)) %>%
  kable(.,digits=2,
        caption='summary of best predictions')


unnest(allbeststats,r2) %>%
  select(simdte,mdlpreds,simyr,r2) %>%
  group_by(mdlpreds,simyr) %>%
  summarise(mean(r2),
            median(r2),
            sd(r2)) %>%
  kable(.,digits=2,
        caption='summary of best predictions by year')
```

## phv

```{r eval=F}

statheatmap(phvstats,'r2')+
  scale_fill_viridis(option = 'C', guide='colorbar',limits=c(0,1))+
  geom_point(data=unnest(bestphv,r2),aes(mdldte,simdte),shape=4)
```

## phvfsca

```{r eval=F}
statheatmap(phvfscastats,'r2')+
  scale_fill_viridis(option = 'C', guide='colorbar',limits=c(0,1))+
  geom_point(data=unnest(bestphv,r2),aes(mdldte,simdte),shape=4)
```


## phvaso

```{r eval=F}

statheatmap(phvasostats,'r2')+
  scale_fill_viridis(option = 'C', guide='colorbar',limits=c(0,1))+
  geom_point(data=unnest(bestphv,r2),aes(mdldte,simdte),shape=4)

```

## phvasofsca
```{r eval=F}

statheatmap(phvasofscastats,'r2')+
  scale_fill_viridis(option = 'C', guide='colorbar',limits=c(0,1))+
  geom_point(data=unnest(bestphv,r2),aes(mdldte,simdte),shape=4)

```



## all model boxplots

```{r}
r2bxp <- 
  allstats %>%
  filter(simyr!=mdlyr) %>%
statboxplots('r2')+
  scale_fill_brewer(palette='Paired',
                    labels=c('PHV','PHV-FSCA','PHV-ASO','PHV-ASO-FSCA'))+
  coord_cartesian(ylim=c(0,1))+
  labs(x='Simulation Date',
       y=expression(r^2))+
  geom_point(data=unnest(allbeststats,r2),aes(simdte,r2,fill=mdlpreds),shape=23,color='red',position=position_jitterdodge(),size=2,show.legend=F)+
  guides(fill=FALSE)+
  theme(legend.justification=c(0,0),
              legend.position=c(0,0.58)
        )


```



# % MAE

```{r results='asis'}
unnest(allbeststats,pctmae) %>%
  select(simdte,mdlpreds,pctmae,predmae,rmse,simyr) %>%
  group_by(mdlpreds) %>%
  summarise(mean(pctmae),
            median(pctmae),
            sd(pctmae),
            mean(predmae,na.rm=T),
            mean(rmse)) %>%
  kable(.,digits=4,
        caption='summary of best predictions')

unnest(allbeststats,pctmae) %>%
  select(simdte,mdlpreds,pctmae,simyr) %>%
  group_by(mdlpreds,simyr) %>%
  summarise(mean(pctmae),
            median(pctmae),
            sd(pctmae)) %>%
  kable(.,digits=2,
        caption='summary of best predictions by year')

unnest(allstats,pctmae) %>%
  select(simdte,mdlpreds,pctmae,simyr) %>%
  group_by(mdlpreds,simyr) %>%
  summarise(mean(pctmae),
            median(pctmae),
            sd(pctmae)) %>%
  kable(.,digits=2,
        caption='summary of all predictions by year')

unnest(allstats,pctmae) %>% 
  group_by(mdlpreds,mdlyr) %>% 
  summarise(mean(pctmae),
            sd(pctmae)) %>% 
  kable(.,digits=2,
        caption='summary of all predictions by model year')
```

## phv

```{r eval=F}
statheatmap(phvstats,'pctmae')+
  scale_fill_viridis(direction=-1,option = 'B', guide='legend',limits=c(0,200))+
  geom_point(data=unnest(bestphv,pctmae),aes(mdldte,simdte),shape=4)

```

## phvfsca
```{r eval=F}
statheatmap(phvfscastats,'pctmae')+
  scale_fill_viridis(direction=-1,option = 'B', guide='legend',limits=c(0,200))+
  geom_point(data=unnest(bestphv,pctmae),aes(mdldte,simdte),shape=4)

```

```{r boxplot_phvfsca_allyears}
ga_m=phvfscastats %>% 
  filter(simyr!=mdlyr) %>% 
    ggplot(aes(x=simdte,y=pctmae))+
    geom_boxplot(outlier.size = .5)+
    geom_point(aes(color=mdlyr),alpha=.5,position='jitter')+
    coord_cartesian(ylim=c(0,300))+
    scale_y_continuous(breaks=seq(0,300,50),labels=sprintf("%4s",seq(0,300,50)))+
    labs(y='%MAE',
         x='Simulation Date',
         title='PHV-FSCA')+
    guides(color=guide_legend('Model Yr',override.aes = list(alpha=1)))+
    facet_grid(~simyr,scales='free')+
    theme_cowplot(font_size=16)+
    theme(axis.text.x=element_text(angle=45,hjust=1),
          strip.background=element_blank(),
          strip.text=element_text(face='bold',size=14),
          plot.title=element_text(face='bold',size=18),
          panel.background=element_rect(),
          panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
          legend.justification=c(0,1),
          legend.position=c(0.01,.99))

# gb=stats %>% 
#     ggplot(aes(x=simdte,y=pctmae))+
#     geom_boxplot(outlier.size = .5)+
#     coord_cartesian(ylim=c(0,300))+
#     geom_text(data=annotedF,aes(x,y,label=label),size=6,hjust=0)+
#   # scale_y_continuous(limits=c(0,1))+
#     labs(y='%MAE',
#          x='Simulation Date')+
#     facet_grid(~simyr,scales='free')+
#     theme_cowplot(font_size=16)+
#     theme(axis.text.x=element_text(angle=45,hjust=1),
#           strip.background=element_blank(),
#           strip.text=element_text(face='bold',size=18))
# 
# pgyr <- plot_grid(ga, gb, nrow=2)
# pgyr

save_plot(ga_m,
          filename=paste0('figs/boxplots_pctmae_phvfsca_allyears.pdf'),
          nrow=1,
          base_width=10)
```

## phvaso

```{r eval=F}

statheatmap(phvasostats,'pctmae')+
  scale_fill_viridis(direction=-1,option = 'B', guide='legend',limits=c(0,200))+
  geom_point(data=unnest(bestphv,pctmae),aes(mdldte,simdte),shape=4)

```

## phvasofsca

```{r eval=F}

statheatmap(phvasofscastats,'pctmae')+
  scale_fill_viridis(direction=-1,option = 'B', guide='legend',limits=c(0,200))+
  geom_point(data=unnest(bestphv,pctmae),aes(mdldte,simdte),shape=4)
```

```{r boxplot_phvasofsca_allyears}
gb_m=phvasofscastats %>% 
  filter(simyr!=mdlyr) %>% 
    ggplot(aes(x=simdte,y=pctmae))+
    geom_boxplot(outlier.size = .5)+
    geom_point(aes(color=mdlyr),alpha=.5,position='jitter')+
    coord_cartesian(ylim=c(0,300))+
    scale_y_continuous(breaks=seq(0,300,50),labels=sprintf("%4s",seq(0,300,50)))+
    labs(y='%MAE',
         x='Simulation Date',
         title='PHV-ASO-FSCA')+
      guides(color=guide_legend('Model Yr',override.aes = list(alpha=1)))+
    facet_grid(~simyr,scales='free')+
    theme_cowplot(font_size=16)+
    theme(axis.text.x=element_text(angle=45,hjust=1),
          strip.background=element_blank(),
          strip.text=element_text(face='bold',size=14),
          plot.title=element_text(face='bold',size=18),
          panel.background=element_rect(),
          panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
          legend.justification=c(0,1),
          legend.position=c(0.01,.99))

save_plot(gb_m,
          filename=paste0('figs/boxplots_pctmae_phvasofsca_allyears.pdf'),
          nrow=1,
          base_width=10)


```



## all model boxplots

```{r}
pctmaebxp <- 
  allstats %>%
  filter(simyr!=mdlyr) %>%
statboxplots('pctmae')+
  coord_cartesian(ylim=c(0,300))+
  geom_point(data=unnest(allbeststats,pctmae),aes(simdte,pctmae,fill=mdlpreds),shape=23,color='red',position=position_jitterdodge(),size=2,show.legend=F)+
  scale_fill_brewer(palette='Paired',
                    labels=c('PHV','PHV-FSCA','PHV-ASO','PHV-ASO-FSCA'))+
  labs(x='Simulation Date',
       y='%MAE')+
  theme(legend.justification=c(0,1),
        legend.position=c(0,1),
        strip.background=element_blank(),
        strip.text=element_text(face='bold',size=16),
        panel.border=element_rect(size=0.5,linetype='solid',color='grey30'))

```

# % Bias

```{r results='asis'}
unnest(allbeststats,pctbias) %>%
  select(simdte,mdlpreds,pctbias,simyr) %>%
  group_by(mdlpreds) %>%
  summarise(mean(pctbias),
            median(pctbias),
            sd(pctbias)) %>%
  kable(.,digits=2,
        caption='summary of best predictions')

unnest(allbeststats,pctbias) %>%
  select(simdte,mdlpreds,pctbias,simyr) %>%
  group_by(mdlpreds,simyr) %>%
  summarise(mean(pctbias),
            median(pctbias),
            sd(pctbias),
            min(pctbias),
            max(pctbias)) %>%
  kable(.,digits=2,
        caption='summary of best predictions by year')

unnest(allstats,pctbias) %>% 
  group_by(mdlpreds,mdlyr) %>% 
  summarise(mean(pctbias),
            sd(pctbias)) %>% 
  kable(.,digits=2,
        caption='summary of all predictions by model year')
```

## phvfsca
```{r boxplot_phvasofsca_allyears}
ga_b=phvfscastats %>% 
  filter(simyr!=mdlyr) %>% 
    ggplot(aes(x=simdte,y=pctbias))+
    geom_hline(aes(yintercept=0))+
    geom_boxplot(outlier.size = .5)+
    geom_point(aes(color=mdlyr),alpha=.5,position='jitter')+
    coord_cartesian(ylim=c(-100,400))+
    scale_y_continuous(breaks=seq(-100,400,50),labels=sprintf("%4s",seq(-100,400,50)))+
    labs(y='%Bias',
         x='Simulation Date',
         title='PHV-FSCA')+
      guides(color=guide_legend('Model Yr',override.aes = list(alpha=1)))+
    facet_grid(~simyr,scales='free')+
    theme_cowplot(font_size=16)+
    theme(axis.text.x=element_text(angle=45,hjust=1),
          strip.background=element_blank(),
          strip.text=element_text(face='bold',size=14),
          plot.title=element_text(face='bold',size=18),
          panel.background=element_rect(),
          panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
          legend.justification=c(0,1),
          legend.position=c(0.01,.99))

save_plot(ga_b,
          filename=paste0('figs/boxplots_pctbias_phvfsca_allyears.pdf'),
          nrow=1,
          base_width=10)


```

## phvasofsca
```{r boxplot_phvasofsca_allyears}
gb_b=phvasofscastats %>% 
  filter(simyr!=mdlyr) %>% 
    ggplot(aes(x=simdte,y=pctbias))+
  
    geom_boxplot(outlier.size = .5)+
    geom_point(aes(color=mdlyr),alpha=.5,position='jitter')+
    coord_cartesian(ylim=c(-100,400))+
    scale_y_continuous(breaks=seq(-100,400,50),labels=sprintf("%4s",seq(-100,400,50)))+
    labs(y='%Bias',
         x='Simulation Date',
         title='PHV-ASO-FSCA')+
      guides(color=guide_legend('Model Yr',override.aes = list(alpha=1)))+
    facet_grid(~simyr,scales='free')+
    theme_cowplot(font_size=16)+
    theme(axis.text.x=element_text(angle=45,hjust=1),
          strip.background=element_blank(),
          strip.text=element_text(face='bold',size=14),
          plot.title=element_text(face='bold',size=18),
          panel.background=element_rect(),
          panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
          legend.justification=c(0,1),
          legend.position=c(0.01,.99))

save_plot(gb_b,
          filename=paste0('figs/boxplots_pctbias_phvasofsca_allyears.pdf'),
          nrow=1,
          base_width=10)


```

```{r}
topax=theme(axis.text.x=element_blank(),
            axis.ticks.x=element_blank(),
            axis.title.x=element_blank(),
            plot.margin=unit(c(7,7,0,7),'pt'))

pg_b <- plot_grid(ga_m+topax,gb_m+topax)
pg_m <- plot_grid(ga_b,gb_b)

multipg2 <- plot_grid(pg_b,pg_m, nrow=2,rel_heights=c(0.6,0.8),align='hv')

save_plot(plot=multipg2,
          filename='figs/prederror_allyrscolors_pctbias_pctmae_best-vs-lowestfscamae.pdf',
          base_width = 12,
          base_aspect_ratio = 4,
          nrow=2,
          ncol=2)

pg_pf <- plot_grid(ga_m+topax,ga_b,
                   nrow=2,
                   align='v',
                   rel_heights = c(0.6,0.8),
                   labels='auto',
                   label_size=20)
save_plot(plot=pg_pf,
          filename='figs/prederror_phvfscaonly_allyrscolors_pctbias_pctmae_best-vs-lowestfscamae.pdf',
          base_width=12,
          base_aspect_ratio = 4,
          nrow=2,
          ncol=1)


```


```{r}
pctbiasbxp <- 
  allstats %>%
  filter(simyr!=mdlyr) %>%
statboxplots('pctbias')+
  coord_cartesian(ylim=c(-500,500))+
  geom_point(data=unnest(allbeststats,pctbias),aes(simdte,pctbias,fill=mdlpreds),shape=23,color='red',position=position_jitterdodge(),size=2,show.legend=F)+
  scale_fill_brewer(palette='Paired',
                    labels=c('PHV','PHV-FSCA','PHV-ASO','PHV-ASO-FSCA'))+
  labs(x='Simulation Date',
       y='%Bias')+
  guides(fill='none')+
  theme(legend.justification=c(0,1),
        legend.position=c(0,1),
        strip.background=element_blank(),
        strip.text=element_text(face='bold',size=16),
        panel.border=element_rect(size=0.5,linetype='solid',color='grey30'))
# pctbiasbxp
```

```{r}
pg_bxp <- plot_grid(r2bxp,pctmaebxp,pctbiasbxp,nrow=3,ncol=1, labels='auto',label_size=24,align='h')
pg_bxp
save_plot(pg_bxp,
          filename='figs/allmodelboxplots_r2-pctmae-pctbias.pdf',
          nrow=3,
          ncol=1,
          base_height=9,
          base_aspect_ratio = 1.5)
```



# are the differences in patterns of fsca and swe similar? can fsca patterns be used to pick the date to predict swe?

comparison of maps for each date but leaving out maps from the same year in the comparison

```{r fsca-pattern-comparison, eval=T}
mdldata <- simdata <-
  alldata %>%
  dplyr::select(dte,x,y,fsca)

mdldata <- mdldata %>% rename(mdldte=dte,
                              mdlfsca=fsca)
simdata <- simdata %>% rename(simdte=dte,
                              simfsca=fsca)
fscadata <- full_join(mdldata,simdata,by=c('x','y'))

fscastats <-
  fscadata %>%
  group_by(mdldte,simdte) %>%
  summarise(mae=mae(simfsca,mdlfsca),
            mse=mse(simfsca,mdlfsca)
  ) %>%
  mutate(simyr=substr(simdte,1,4),
         mdlyr=substr(mdldte,1,4))

bestfsca_mae <-
  fscastats %>%
  filter(mdlyr!=simyr) %>%
  group_by(simdte,simyr) %>%
  summarise(mdldte=mdldte[which.min(mae)],
            mdlyr=substr(mdldte,1,4),
            mae=min(mae))
bestfsca_mse <-
  fscastats %>%
  filter(mdlyr!=simyr) %>%
  group_by(simdte,simyr) %>%
  summarise(mdldte=mdldte[which.min(mse)],
            mdlyr=substr(mdldte,1,4),
            mae=min(mse))

```

```{r plot_fscadiff-snowdiff}
mdldata <- simdata <-
  alldata %>%
  dplyr::select(dte,x,y,swe)

mdldata <- mdldata %>% rename(mdldte=dte,
                              mdlswe=swe)
simdata <- simdata %>% rename(simdte=dte,
                              simswe=swe)
swedata <- full_join(mdldata,simdata,by=c('x','y'))

swestats <-
  swedata %>%
  group_by(mdldte,simdte) %>%
  summarise(mae=mae(simswe,mdlswe),
            mse=mse(simswe,mdlswe)
  ) %>%
  mutate(simyr=substr(simdte,1,4),
         mdlyr=substr(mdldte,1,4),
         var='swe')

mse_stats <- bind_rows(swestats,fscastats %>% mutate(var='fsca')) %>%
  dplyr::select(-mae) %>%
  spread(var,mse) %>%
  mutate(diffmetric='mse')

mae_stats <-  bind_rows(swestats,fscastats %>% mutate(var='fsca')) %>%
  dplyr::select(-mse) %>%
  spread(var,mae) %>%
  mutate(diffmetric='mae')

snow_stats=bind_rows(mse_stats,mae_stats)

```

## with mean absolute error

```{r swemae_vs_fscamae}
snow_stats_otheryrs <-
  snow_stats %>%
  filter(diffmetric=='mae',
         simyr!=mdlyr)

sslm <-
  snow_stats_otheryrs %>%
  group_by(simdte) %>%
  nest() %>%
  mutate(mdlobj=map(data,~glm(swe~fsca,data=.)))

ssr2 <-
  sslm %>%
  unnest(map(mdlobj,glance)) %>%
  select(simdte,mdlobj) %>%
  mutate(x=0,
         # y=1,
         label=map_chr(mdlobj,bestfit_r2,multiline=TRUE))

datamax <- snow_stats_otheryrs %>%
  group_by(simdte) %>%
  summarise(y=max(swe))

ssr2 <-
  left_join(ssr2,datamax,by='simdte')

g <- 
  ggplot(snow_stats_otheryrs,aes(x=fsca,y=swe))+
  geom_point(aes(color=mdlyr))+
  geom_smooth(method='lm',color='black')+
  guides(color=guide_legend('Model Yr'))+
  geom_text(data=ssr2,aes(x,y,label=label),parse=TRUE,hjust=0,vjust=1,nudge_x=-0.01,nudge_y=0.05)+#,fill='white',alpha=0.5,label.padding = unit(0.2, "lines"), label.r = unit(0.15, "lines"),label.size = 0.1)+
  facet_wrap(~simdte,scales='free')+
  labs(x='pixel-wise fSCA similarity',
       y='pixel-wise SWE similarity')+
  theme(strip.background=element_blank(),
        strip.text=element_text(face='bold'),
        legend.justification=c(1,0),
        legend.position=c(.99,0.0))

ggsave(g,filename='figs/swesimilarity_fscasimilarity_color.pdf',width=12,height=10)



```

## with mean squared error

more dates are statistically significant with mae so we'll stick with that.

```{r swemse_vs_fscamse, eval=F}
snow_stats_otheryrs <-
  snow_stats %>%
  filter(diffmetric=='mse',
         simyr!=mdlyr)

sslm <-
  snow_stats_otheryrs %>%
  group_by(simdte) %>%
  nest() %>%
  mutate(mdlobj=map(data,~glm(swe~fsca,data=.)))

ssr2 <-
  sslm %>%
  unnest(map(mdlobj,glance)) %>%
  select(simdte,mdlobj) %>%
  mutate(x=0,
         # y=1,
         label=map_chr(mdlobj,bestfit_r2,multiline=TRUE))

datamax <- snow_stats_otheryrs %>%
  group_by(simdte) %>%
  summarise(y=max(swe))

ssr2 <-
  left_join(ssr2,datamax,by='simdte')

ggplot(snow_stats_otheryrs,aes(x=fsca,y=swe))+
  geom_point()+
  geom_smooth(method='lm')+
  geom_text(data=ssr2,aes(x,y,label=label),parse=TRUE,hjust=0,vjust=1)+
  facet_wrap(~simdte,scales='free')

```



# compare prediction errors vs basin aggregated snow variables

```{r calculate_basinstats}
basinstats <-
  alldata %>%
  dplyr::select(dte,swe,fsca) %>%
  group_by(dte) %>%
  summarise(
    avg_swe=mean(swe),
    mv_swe=sd(swe)*mean(swe),
    med_fsca=median(fsca),
    mv_fsca=sd(fsca)*median(fsca)
  )

# prediction errors
l=list(bestphv,bestphvfsca,bestphvaso,bestphvasofsca)
ev=c('r2','pctmae','pctbias')
mylist=lapply(l,FUN=function(x){
  lapply(ev,FUN=function(v1) list(x,v1))
}) %>% unlist(recursive=F)#or purrr::flatten


```

```{r fun-prederrors-snow}
compare_mdlsim <- function(mdlpreds1,errorvar,errordF){
  dF1 <-
    left_join(select_(errordF,~matches('sim'),as.name(errorvar)),
              basinstats,by=c('simdte'='dte')) %>%
    rename(dte=simdte,
           yr=simyr) %>%
    mutate(mdlpreds=mdlpreds1,
           type='sim')

  dF2 <- left_join(select_(errordF,~matches('mdl'),as.name(errorvar)),
                   basinstats,by=c('mdldte'='dte')) %>%
    rename(dte=mdldte,
           yr=mdlyr) %>%
    mutate(type='mdl')

  alldF <-
    bind_rows(dF1,dF2) %>%
    group_by_(as.name(errorvar)) %>%
    mutate(avgswediff=abs(diff(avg_swe)/avg_swe[1])*100,
           mvswediff=abs(diff(mv_swe)/mv_swe[1])*100,
           medfscadiff=abs(diff(med_fsca)/med_fsca[1])*100,
           mvfscadiff=abs(diff(mv_fsca)/mv_fsca[1]*100)) %>%
    gather(snowvar,snowval,avgswediff:mvfscadiff) %>%
    mutate(snowvar=factor(snowvar,levels=c('avgswediff','mvswediff','medfscadiff','mvfscadiff')))

  return(alldF)
}

plot_error_snow <- function(alldF,errorvar){
  if(errorvar=='r2') {
    errlab='r^2'
    leg=theme(legend.justification=c(1,0),
              legend.position=c(1,0))
  } else {
    errlab='"%"*MAE'
    leg=theme(legend.justification=c(1,1),
              legend.position=c(1,1))
  }
  errlab=parse(text = paste0(errlab,'~of~prediction'))
  limx=coord_cartesian(xlim=c(0,500))

  ggplot(alldF,aes_(x=~snowval,y=as.name(errorvar),colour=~snowvar))+
    geom_point()+
    geom_smooth(method='lm',se=F)+
    labs(x='|sim-mdl|/sim*100 [%]',y=errlab,title=unique(alldF$mdlpreds))+
    scale_color_brewer(palette='Paired')+
    limx+
    leg
}
```

## compare with best errors

this doesn't show much. errors go up end of season while mean swe goes down....

```{r plot-bestprederror-basinsnow, eval=F}
snowdata2plot <-
  lapply(X=mylist,FUN=function(lst){
  # print(head(lst))
    mdldF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
  alldF <-
    compare_mdlsim(unique(mdldF$mdlpreds),errorvar,unnest_(mdldF,as.name(errorvar),.drop=TRUE))
  return(list(alldF,errorvar))
  })

myplots <-
  lapply(snowdata2plot,FUN=function(lst) {
    # print(lst)
    dF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
  plot_error_snow(dF,errorvar)
})
plot_grid(plotlist=myplots,
          ncol=2,
          align='hv',
          labels=paste0('(',seq(1,8,1),')'))

```

```{r table-prederror-basinsnow, results='asis', eval=F}
# mdlpreds='phvfsca'
# mdldF=bestphvfsca
# errorvar='pctmae'
# rm(mdlpreds,mdldF,errorvar,lst)

bestfitlines=lapply(X=snowdata2plot,FUN=function(lst){
    # print(head(lst))
    mdldF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
    myformula=as.formula(paste(errorvar,'~ basinmetricval'))
    lmdF <-
      unnest_(mdldF,as.name(errorvar),.drop=T) %>%
      left_join(basinstats) %>%
      gather(basinmetricvar,basinmetricval,avg_swe:mv_fsca) %>%
      group_by(basinmetricvar,mdlpreds) %>%
      nest() %>%
      mutate(lmobj=map(data,function(x) lm(myformula,data=x)))
    return(lmdF$lmobj)
  })

# mdllabs <-
#   paste(
#   paste(rep(c('phv','phvfsca','phvaso','phvasofsca'),each=4),rep(c('r2','pctmae'),each=2),sep='.'),
#   rep(c('mae','mse'),length.out=16),sep='.')
mdllabs <- paste(rep(c('phv','phvfsca','phvaso','phvasofsca'),each=2),rep(c('r2','pctmae'),each=1),sep='.')
stargazer(bestfitlines,
          type='html',
          ci=FALSE,
          flip=TRUE,
          # covariate.labels=rep(c('fscadiff',),length.out=16),
          dep.var.labels = mdllabs,
          column.labels=paste0(rep(seq(1,8),each=4),c('as','mvs','mf','mvf')),
          keep.stat=c('rsq'),
          digits=2,
          report=c('vc*'),
          no.space=F,
          out='output/table_predictionerrors-basinsnow.html')


```

## compare with all errors

```{r plot-allprederror-basinsnow, fig.width=24}
#, fig.height=2*24}
l2=list(phvstats,phvfscastats,phvasostats,phvasofscastats)
ev=c('r2','pctmae')
mylist_all=lapply(l2,FUN=function(x){
  lapply(ev,FUN=function(v1) list(x,v1))
}) %>% unlist(recursive=F)#or purrr::flatten

snowdata2plot_all <-
  lapply(X=mylist_all,FUN=function(lst){
  # print(head(lst))
    mdldF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
  alldF <-
    compare_mdlsim(unique(mdldF$mdlpreds),errorvar,mdldF)
  return(list(alldF,errorvar))
  })

myplots_all <-
  lapply(snowdata2plot_all,FUN=function(lst) {
    # print(lst)
    dF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
    g <- plot_error_snow(dF,errorvar)+
            facet_wrap(~dte,scales='free')+
            coord_cartesian(xlim=c(0,125))
    if(errorvar=='pctmae') g <- g + coord_cartesian(xlim=c(0,125),ylim=c(0,200)) + theme(legend.position=c(.96,.12))
    return(g)
    })

# plot_grid(plotlist=myplots_all[3:4],ncol=2,align='hv')
# plot_grid(plotlist=myplots_all[7:8],ncol=2,align='hv')

pg_snow <-
  plot_grid(plotlist=myplots_all,
            ncol=2,
            align='hv',
            labels=paste0('(',seq(1,8,1),')'))
# show(pg_snow)
save_plot(pg_snow,nrow=8,ncol=2,filename='figs/so_many_snowplots.pdf',base_width=12)
```

# compare prediction errors vs fsca pattern differences
```{r fscastats_rasters, eval=F}

fscastats %>%
  select(-mse) %>%
ggplot()+
  geom_raster(aes(x=mdldte,y=simdte,fill=mae))+
  geom_point(data=bestfsca_mae,aes(x=mdldte,y=simdte),shape=4)+
  coord_fixed()+
  facet_grid(simyr~mdlyr,scales='free',space='free',as.table=FALSE)+
  scale_fill_viridis(option = 'D',direction = -1)+
  theme(axis.text.x=element_text(angle=45,hjust=1))+
  labs(title='MAE')

fscastats %>%
  select(-mae) %>%
ggplot()+
  geom_raster(aes(x=mdldte,y=simdte,fill=mse))+
  geom_point(data=bestfsca_mse,aes(x=mdldte,y=simdte),shape=4)+
  coord_fixed()+
  facet_grid(simyr~mdlyr,scales='free',space='free',as.table=FALSE)+
  scale_fill_viridis(option = 'D',direction = -1)+
  theme(axis.text.x=element_text(angle=45,hjust=1))+
  labs(title='MSE')

```

```{r fun-prederrors-fsca}
plot_error_fsca <- function(alldF,errorvar){
  if(errorvar=='r2') {
    yax=coord_cartesian()
    errlab='r^2'
    leg=theme(legend.justification=c(1,0),
              legend.position=c(1,0))
  } else if(errorvar=='pctmae'){
    yax=coord_cartesian()#coord_cartesian(ylim=c(0,200))
    errlab='"%"*MAE'
    leg=theme(legend.justification=c(1,1),
              legend.position=c(1,1))
  } else if(errorvar=='pctbias'){
    yax=coord_cartesian()#coord_cartesian(ylim=c(0,200))
    errlab='"%"*Bias'
    leg=theme(legend.justification=c(1,0),
              legend.position=c(1,0))
  }
  errlab=parse(text = paste0(errlab,'~of~prediction'))

  ggplot(alldF,aes_(x=~fscametricval,y=as.name(errorvar),colour=~fscametricvar))+
    geom_point()+
    geom_smooth(method='lm',se=F)+
    yax+
    labs(x='pixel-wise pattern difference',y=errlab,title=unique(alldF$mdlpreds))+
    scale_color_brewer(palette='Paired')+
    leg
}

```

## compare with best errors only

again not a very useful plot. errors go up as fsca mae goes down (due to smaller differences when there is less snow cover)

```{r plot-bestprederrors-fscapattern, eval=F}
#use mylist from other error plots above
fscadata2plot <-
  lapply(X=mylist,FUN=function(lst){
    # print(head(lst))
    mdldF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
    alldF <-
      unnest_(mdldF,as.name(errorvar),.drop=T) %>%
      left_join(fscastats) %>%
      gather(fscametricvar,fscametricval,mae,mse) %>%
        filter(simyr!=mdlyr)
    return(list(alldF,errorvar))
  })

myplots <-
  lapply(fscadata2plot,FUN=function(lst){
    dF=lst[[1]]
    errorvar=lst[[2]]
    plot_error_fsca(dF,errorvar)
  })

plot_grid(plotlist=myplots,ncol=2,align='hv',labels=paste0('(',seq(1,8,1),')'))
            # paste(paste0('(',seq(1,16,2),')'),paste0('(',seq(2,16,2),')'),sep=','))

```

```{r table-predictionerrors-fscapattern, results='asis', eval=F}
mdldF=bestphvfsca
errorvar='pctmae'
rm(mdldF,errorvar)

bestfitlines=lapply(X=fscadata2plot,FUN=function(lst){
    # print(head(lst))
    mdldF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
    myformula=as.formula(paste(errorvar,'~ fscametricval'))
    lmdF <-
      mdldF %>%
      group_by(fscametricvar,mdlpreds) %>%
      nest() %>%
      mutate(lmobj=map(data,function(x) lm(myformula,data=x)))
    return(lmdF$lmobj)
  })


# mdllabs <-
#   paste(
#   paste(rep(c('phv','phvfsca','phvaso','phvasofsca'),each=4),rep(c('r2','pctmae'),each=2),sep='.'),
#   rep(c('mae','mse'),length.out=16),sep='.')
mdllabs <- paste(rep(c('phv','phvfsca','phvaso','phvasofsca'),each=2),rep(c('r2','pctmae'),each=1),sep='.')

stargazer(bestfitlines,type='html',ci=FALSE,flip=F,
          # covariate.labels=rep(c('fscadiff',),length.out=16),
          dep.var.labels = mdllabs,
          column.labels=paste0(rep(seq(1,8),each=2),c('a','s')),
          keep.stat=c('rsq'),
          digits=2,
          report=c('vc*'),
          no.space=F,
          out='output/table_predictionerrors-fscametrics.html')
```

## compare with all errors by date

```{r plot-allprederrors-fscapattern, results='asis',fig.width=24}
#,fig.height=2*24}
l2=list(phvstats,phvfscastats,phvasostats,phvasofscastats)
ev=c('r2','pctmae','pctbias')
mylistall=lapply(l2,FUN=function(x){
  lapply(ev,FUN=function(v1) list(x,v1))
}) %>% unlist(recursive=F)#or purrr::flatten

```

```{r fscastats_similarity}

#use mylist from other error plots above
fscadata2plot_all <-
  lapply(X=mylistall,FUN=function(lst){
    # print(head(lst))
    mdldF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
    alldF <-
      mdldF %>%
      left_join(fscastats) %>%
      gather(fscametricvar,fscametricval,mae,mse) %>%
        filter(simyr!=mdlyr)
    return(list(alldF,errorvar))
  })


myplots_all <-
  lapply(fscadata2plot_all,FUN=function(lst){
    dF=lst[[1]]
    errorvar=lst[[2]]
    g <- plot_error_fsca(dF %>% filter(fscametricvar=='mae'),errorvar)+
      facet_wrap(~simdte,scales='free')
    if(errorvar=='pctmae') g <- g + theme(legend.position=c(.98,.13))
    return(g)
  })
# plot_grid(plotlist=myplots_all[3:4],ncol=2,align='hv')
# plot_grid(plotlist=myplots_all[7:8],ncol=2,align='hv')

pg=plot_grid(plotlist=myplots_all,ncol=3,align='hv',labels=paste0('(',seq(1,16,1),')'))
# show(pg)
save_plot(pg,nrow=8,ncol=2,base_width=18,filename = 'figs/so_many_fscaplots2.pdf')
```

see "figs/so_many_fscaplots.pdf" for all plots

## Table of significant slopes

```{r table_slopes, results='asis', fig.width=24,out.width='\\textwidth'}

slopedf <-
  bind_rows(
    lapply(fscadata2plot_all,function(lst){
      dF=lst[[1]]
      errorvar=lst[[2]]
      myform=as.formula(paste(errorvar,'~fscametricval'))
      newlist <-
        dF %>%
        filter(fscametricvar=='mae') %>%
        split(.$simdte) %>%
        map(~lm(myform,data=.)) %>%
        map(tidy)
      bind_rows(newlist) %>% mutate(simdte=rep(names(newlist),each=2),
                                    errorvar,
                                    mdlpreds=rep(unique(dF$mdlpreds),2*length(newlist)))
    })
  )

r2slopes <-
  slopedf %>%
  select(simdte,term,estimate,p.value,errorvar,mdlpreds) %>%
  filter(term!='(Intercept)',errorvar=='r2') %>%
  spread(errorvar,estimate)

r2slp <-
  r2slopes %>%
  select(simdte,mdlpreds,r2,p.value) %>%
  rename(slope=r2) %>%
  mutate(slope=ifelse(p.value<=0.05,sprintf(fmt='%.02f',slope),'-'),
         mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')),
         simdte=as.character(strftime(strptime(simdte,'%Y%m%d'),'%Y-%m-%d'))) %>%
  select(-p.value) %>%
  spread(mdlpreds,slope) %>%
  mutate(sep='| ')


pctmaeslopes <-
  slopedf %>%
  select(simdte,term,estimate,p.value,errorvar,mdlpreds) %>%
  filter(term!='(Intercept)',errorvar=='pctmae') %>%
  spread(errorvar,estimate)

pctmslp <-
  pctmaeslopes %>%
  select(simdte,mdlpreds,pctmae,p.value) %>%
  rename(slope=pctmae) %>%
  mutate(slope=ifelse(p.value<=0.05,sprintf(fmt='%.02f',slope),'-'),
         mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')),
         simdte=as.character(strftime(strptime(simdte,'%Y%m%d'),'%Y-%m-%d'))) %>%
  select(-p.value) %>%
  spread(mdlpreds,slope)


stargazer(bind_cols(r2slp,pctmslp),
          type='html',
          summary=FALSE,
          rownames=FALSE,
          no.space=TRUE,
          out = 'output/prederror_slopes_allerrors-fscamae.html')

```


```{r swestats_similarity}
#use mylist from other error plots above
swedata2plot_all <-
  lapply(X=mylistall,FUN=function(lst){
    # print(head(lst))
    mdldF=lst[[1]]
    errorvar=lst[[2]]
    # print(errorvar)
    alldF <-
      mdldF %>%
      left_join(swestats) %>%
      gather(fscametricvar,fscametricval,mae,mse) %>%
        filter(simyr!=mdlyr)
    return(list(alldF,errorvar))
  })


myplots_all <-
  lapply(swedata2plot_all,FUN=function(lst){
    dF=lst[[1]]
    errorvar=lst[[2]]
    g <- plot_error_fsca(dF %>% filter(fscametricvar=='mae'),errorvar)+
      facet_wrap(~simdte,scales='free')
    if(errorvar=='pctmae') g <- g + theme(legend.position=c(.98,.13))
    return(g)
  })
# plot_grid(plotlist=myplots_all[3:4],ncol=2,align='hv')
# plot_grid(plotlist=myplots_all[7:8],ncol=2,align='hv')

pg=plot_grid(plotlist=myplots_all,ncol=3,align='hv',labels=paste0('(',seq(1,16,1),')'))
# show(pg)
save_plot(pg,nrow=8,ncol=3,base_width=18,filename = 'figs/so_many_sweplots2.pdf',limitsize=F)


```

## Table of significant slopes

```{r table_slopes, results='asis', fig.width=24}

slopedf <-
  bind_rows(
    lapply(swedata2plot_all,function(lst){
      dF=lst[[1]]
      errorvar=lst[[2]]
      myform=as.formula(paste(errorvar,'~fscametricval'))
      newlist <-
        dF %>%
        filter(fscametricvar=='mae') %>%
        split(.$simdte) %>%
        map(~lm(myform,data=.)) %>%
        map(tidy)
      bind_rows(newlist) %>% mutate(simdte=rep(names(newlist),each=2),
                                    errorvar,
                                    mdlpreds=rep(unique(dF$mdlpreds),2*length(newlist)))
    })
  )

r2slopes <-
  slopedf %>%
  select(simdte,term,estimate,p.value,errorvar,mdlpreds) %>%
  filter(term!='(Intercept)',errorvar=='r2') %>%
  spread(errorvar,estimate)

r2slp <-
  r2slopes %>%
  select(simdte,mdlpreds,r2,p.value) %>%
  rename(slope=r2) %>%
  mutate(slope=ifelse(p.value<=0.05,sprintf(fmt='%.02f',slope),'-'),
         mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')),
         simdte=as.character(strftime(strptime(simdte,'%Y%m%d'),'%Y-%m-%d'))) %>%
  select(-p.value) %>%
  spread(mdlpreds,slope) %>%
  mutate(sep='| ')


pctmaeslopes <-
  slopedf %>%
  select(simdte,term,estimate,p.value,errorvar,mdlpreds) %>%
  filter(term!='(Intercept)',errorvar=='pctmae') %>%
  spread(errorvar,estimate)

pctmslp <-
  pctmaeslopes %>%
  select(simdte,mdlpreds,pctmae,p.value) %>%
  rename(slope=pctmae) %>%
  mutate(slope=ifelse(p.value<=0.05,sprintf(fmt='%.02f',slope),'-'),
         mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')),
         simdte=as.character(strftime(strptime(simdte,'%Y%m%d'),'%Y-%m-%d'))) %>%
  select(-p.value) %>%
  spread(mdlpreds,slope)%>%
  mutate(sep='| ')

pctbiasslopes <-
  slopedf %>%
  select(simdte,term,estimate,p.value,errorvar,mdlpreds) %>%
  filter(term!='(Intercept)',errorvar=='pctbias') %>%
  spread(errorvar,estimate)

pctbslp <-
  pctbiasslopes %>%
  select(simdte,mdlpreds,pctbias,p.value) %>%
  rename(slope=pctbias) %>%
  mutate(slope=ifelse(p.value<=0.05,sprintf(fmt='%.02f',slope),'-'),
         mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')),
         simdte=as.character(strftime(strptime(simdte,'%Y%m%d'),'%Y-%m-%d'))) %>%
  select(-p.value) %>%
  spread(mdlpreds,slope)


stargazer(bind_cols(r2slp,pctmslp,pctbslp),
          type='html',
          summary=FALSE,
          rownames=FALSE,
          no.space=TRUE,
          out = 'output/prederror_slopes_allerrors-swemae2.html')

```



## combine pred error best fit lines by mdlpreds, plot mean +/- se

```{r plot_combinedslopes_fsca, fig.height=12}

## --- to look at the regression of all the data at once ----

# stats_with_fscastats <- bind_rows(phvstats,phvfscastats,phvasostats,phvasofscastats) %>% left_join(fscastats %>% select(-mse))
#
# tt <- stats_with_fscastats %>%
#   gather(errorvar,errorval,r2,pctmae)
#
# tt %>%
#   ggplot(aes(x=mae,y=errorval))+
#   geom_point(alpha=0.8)+
#   geom_smooth(method='lm',se=T)+
#   facet_grid(errorvar~mdlpreds,scales='free')
#
# tt %>%
#   group_by(mdlpreds,errorvar) %>%
#   nest() %>%
#   mutate(obj=map(data,~lm(errorval~mae,data=.)),
#          gl=map(obj,glance),
#          td=map(obj,tidy)) %>%
#   unnest(td,.drop=T) %>% View

## fit bestline trhough each date separately to create ensemble. plot mean and se below
lst=fscadata2plot_all[[1]]
slopedf <-
  bind_rows(
    lapply(fscadata2plot_all,function(lst){
      dF=lst[[1]]
      errorvar=lst[[2]]
      myform=as.formula(paste(errorvar,'~fscametricval'))
      newlist <-
        dF %>%
        filter(fscametricvar=='mae') %>%
        split(.$simdte) %>%
        map(~lm(myform,data=.)) %>%
        map(function(obj) {
          newdata=data.frame(fscametricval=seq(0,1,.01))
          if(glance(obj)$p.value<=0.05){
            data_frame(fscamae=seq(0,1,0.01),
                       pred=predict(object=obj,newdata=newdata)
            )} else {
              # print(obj$model)
            data_frame(fscamae=seq(0,1,0.01),
                       pred=mean(obj$model[,1]))
            }
            })

      bind_rows(newlist,.id='simdte') %>%
        mutate(errorvar,
               mdlpreds=unique(dF$mdlpreds))
    })
  )

tt=slopedf %>%
  group_by(mdlpreds,errorvar,simdte) %>%
  nest() %>%
  mutate(obj=map(data,~lm(pred~fscamae,data=.)),
         tdy=map(obj,tidy),
         slope=map(tdy,function(x) x %>% select(term,estimate,p.value) %>% filter(term=='fscamae'))
  ) %>%
  unnest(slope,.drop=T)


# differences in slope between fsca models are not statistically different
print(
  tt %>%
  filter(mdlpreds=='phvasofsca' | mdlpreds=='phvfsca') %>%
  spread(mdlpreds,estimate) %>%
  split(.$errorvar) %>%
  map(function(x) t.test(x$phvfsca,x$phvasofsca))
)

combinedslope_stats <-
  tt %>%
  split(list(.$mdlpreds,.$errorvar)) %>%
  map_df(function(x) tidy(t.test(x$estimate)),.id='facet') %>% separate(facet,into=c('mdlpreds','errorvar'))

mdf <-
  combinedslope_stats %>%
  select(mdlpreds,errorvar,m=estimate,p.value) %>%
  arrange(mdlpreds,errorvar) %>%
  ungroup %>%
  mutate(x=0,
         y=c(300,0,300,0,300,0,300,0),
         label=paste('slope =',sprintf(fmt='%.2f',m),'\np = ',sprintf(fmt='%.2f',p.value))
  )
mdf

combinedslopedf <-
  slopedf %>%
  group_by(mdlpreds,errorvar,fscamae) %>%
  summarise(avg=mean(pred),
            se=sd(pred)/sqrt(n()),
            u=avg+se,
            l=avg-se)


plot_cbd=function(dF,errorvar){
  if(errorvar=='r2') {
    errlab='r^2'
    xlabel=NULL
    leg=theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              strip.text=element_text(size=18,face='bold'),
              strip.background=element_rect(fill=NA,color='black')# plot.margin=unit(c(7,7,0,7),'pt')
    )
  } else {
    errlab='"%"*MAE'
    xlabel='pixel-wise FSCA similarity'
    leg=theme(strip.background=element_blank(),
              strip.text=element_blank(),
              axis.title.x=element_text(size=18),
              axis.text.x=element_text(size=16, angle=45, hjust=1)
              # plot.margin=unit(c(-7,7,7,7),'pt')
    )

  }
  errlab=parse(text = paste0(errlab,'~of~prediction'))

  errorvar1=errorvar
  mdf1=mdf %>% filter_(~errorvar==errorvar1) %>% 
    mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')))
  slopedf1=slopedf %>% 
    filter_(~errorvar==errorvar1,~pred<500) %>% 
    mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')))
  dF_grp <-
    dF %>%
    ungroup %>%
    filter_(~errorvar==errorvar1) %>% 
    mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')))

  ggplot()+
    geom_line(data=slopedf1,aes(x=fscamae,y=pred,group=simdte),color='grey90')+
    geom_ribbon(data=dF_grp,aes(x=fscamae,ymin=l,ymax=u), fill='grey10',alpha=0.5)+
    geom_path(data=dF_grp,aes(x=fscamae,y=avg),size=1.5,color='blue')+
    geom_text(data=mdf1,aes(x,y,label=label),hjust=0,vjust=0,size=6)+
    facet_grid(~mdlpreds,scales='fixed', labeller=labeller(mdlpreds=tostring))+
    labs(x=xlabel,
         y=errlab)+
    leg+
    theme(axis.text.y=element_text(size=16),
          axis.title.y=element_text(size=18))
}

tostring=as_labeller(c('phv'='PHV','phvfsca'='PHV-FSCA','phvaso'='PHV-ASO','phvasofsca'='PHV-ASO-FSCA'))
g1=plot_cbd(combinedslopedf,'r2')
g2=plot_cbd(combinedslopedf,'pctmae')
pg=plot_grid(g1,g2,align='v',ncol=1,nrow=2,labels='auto',label_size=20)
pg
save_plot(plot=pg,filename = 'figs/xdate_meanfit_fscasimilarity.pdf',nrow=2, base_width=12)

combinedslopedf %>%
  group_by(mdlpreds,errorvar) %>%
  summarise(mean(se),
            min(se),
            max(se),
            max(se)-min(se))


```

```{r plot_combinedslopes_swe, fig.height=12}

## fit bestline trhough each date separately to create ensemble. plot mean and se below
lst=swedata2plot_all[[1]]
slopedf <-
  bind_rows(
    lapply(swedata2plot_all,function(lst){
      dF=lst[[1]]
      errorvar=lst[[2]]
      myform=as.formula(paste(errorvar,'~fscametricval'))
      newlist <-
        dF %>%
        filter(fscametricvar=='mae') %>%
        split(.$simdte) %>%
        map(~lm(myform,data=.)) %>%
        map(function(obj) {
          newdata=data.frame(fscametricval=seq(0,1,.01))
          if(glance(obj)$p.value<=0.05){
            data_frame(fscamae=seq(0,1,0.01),
                       pred=predict(object=obj,newdata=newdata)
            )} else {
              # print(obj$model)
            data_frame(fscamae=seq(0,1,0.01),
                       pred=mean(obj$model[,1]))
            }
            })

      bind_rows(newlist,.id='simdte') %>%
        mutate(errorvar,
               mdlpreds=unique(dF$mdlpreds))
    })
  )

tt=slopedf %>%
  group_by(mdlpreds,errorvar,simdte) %>%
  nest() %>%
  mutate(obj=map(data,~lm(pred~fscamae,data=.)),
         tdy=map(obj,tidy),
         slope=map(tdy,function(x) x %>% select(term,estimate,p.value) %>% filter(term=='fscamae'))
  ) %>%
  unnest(slope,.drop=T)


# differences in slope between fsca models ARE NOT statistically different for pctmae. yes for r2
print(
  tt %>%
  filter(mdlpreds=='phvasofsca' | mdlpreds=='phvfsca') %>%
  spread(mdlpreds,estimate) %>%
  split(.$errorvar) %>%
  map(function(x) t.test(x$phvfsca,x$phvasofsca))
)

combinedslope_stats <-
  tt %>%
  split(list(.$mdlpreds,.$errorvar)) %>%
  map_df(function(x) tidy(t.test(x$estimate)),.id='facet') %>% separate(facet,into=c('mdlpreds','errorvar'))

mdf <-
  combinedslope_stats %>%
  select(mdlpreds,errorvar,m=estimate,p.value) %>%
  arrange(mdlpreds,errorvar) %>%
  ungroup %>%
  mutate(x=0,
         y=c(1000,900,0,1000,900,0,1000,900,0,1000,900,0),
         label=paste('slope =',sprintf(fmt='%.2f',m),'\np = ',sprintf(fmt='%.2f',p.value))
  )
mdf

combinedslopedf <-
  slopedf %>%
  group_by(mdlpreds,errorvar,fscamae) %>%
  summarise(avg=mean(pred),
            se=sd(pred)/sqrt(n()),
            u=avg+se,
            l=avg-se)


plot_cbd=function(dF,errorvar){
  if(errorvar=='r2') {
    errlab='r^2'
    xlabel=NULL
    leg=theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank(),
              strip.text=element_text(size=18,face='bold'),
              strip.background=element_rect(fill=NA,color='black')# plot.margin=unit(c(7,7,0,7),'pt')
    )
  } else if(errorvar=='pctmae'){
    errlab='"%"*MAE'
    xlabel='pixel-wise SWE similarity'
    leg=theme(strip.background=element_blank(),
              strip.text=element_blank(),
              axis.title.x=element_text(size=18),
              axis.text.x=element_text(size=16, angle=45, hjust=1)
              # plot.margin=unit(c(-7,7,7,7),'pt')
    ) 
    } else if(errorvar=='pctbias'){
    errlab='"%"*Bias'
    xlabel='pixel-wise SWE similarity'
    leg=theme(strip.background=element_blank(),
              strip.text=element_blank(),
              axis.title.x=element_text(size=18),
              axis.text.x=element_text(size=16, angle=45, hjust=1)
    )
              # plot.margin=unit(c(-7,7,7,7),'pt')
    }
  errlab=parse(text = paste0(errlab,'~of~prediction'))

  errorvar1=errorvar
  mdf1=mdf %>% filter_(~errorvar==errorvar1) %>% 
    mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')))
  slopedf1=slopedf %>% 
    filter_(~errorvar==errorvar1,~pred<1500) %>% 
    mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')))
  dF_grp <-
    dF %>%
    ungroup %>%
    filter_(~errorvar==errorvar1) %>% 
    mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca')))

  ggplot()+
    geom_line(data=slopedf1,aes(x=fscamae,y=pred,group=simdte),color='grey90')+
    geom_ribbon(data=dF_grp,aes(x=fscamae,ymin=l,ymax=u), fill='grey10',alpha=0.5)+
    geom_path(data=dF_grp,aes(x=fscamae,y=avg),size=1.5,color='blue')+
    geom_text(data=mdf1,aes(x,y,label=label),hjust=0,vjust=0,size=6)+
    facet_grid(~mdlpreds,scales='fixed', labeller=labeller(mdlpreds=tostring))+
    labs(x=xlabel,
         y=errlab)+
    leg+
    theme(axis.text.y=element_text(size=16),
          axis.title.y=element_text(size=18))
}

tostring=as_labeller(c('phv'='PHV','phvfsca'='PHV-FSCA','phvaso'='PHV-ASO','phvasofsca'='PHV-ASO-FSCA'))
g1=plot_cbd(combinedslopedf,'r2')
g2=plot_cbd(combinedslopedf,'pctmae')
g3=plot_cbd(combinedslopedf,'pctbias')
pg=plot_grid(g1,g2,g3,align='v',ncol=1,nrow=3,labels='auto',label_size=20)
pg
save_plot(plot=pg,filename = 'figs/xdate_meanfit_swesimilarity.pdf',nrow=3, base_width=12)

combinedslopedf %>%
  group_by(mdlpreds,errorvar) %>%
  summarise(mean(se),
            min(se),
            max(se),
            max(se)-min(se))


```

# compare best pred vs lowestfscamae pred

```{r compare_bestpred_fscamaepred, eval=T}

combo2predict <-
  fscastats %>%
  filter(mdlyr!=simyr) %>%
  group_by(simdte) %>%
  # summarise(mdldte=mdldte[which.min(mae)])
  do(data_frame(mae=.$mae[order(.$mae)[1:1]],#can increase to see all the x lowest fscamae dates
                mdldte=.$mdldte[order(.$mae)[1:1]]))

fscamae_stats <-
  bind_rows(
    left_join(combo2predict,phvstats),
    left_join(combo2predict,phvfscastats),
    left_join(combo2predict,phvasostats),
    left_join(combo2predict,phvasofscastats)
  ) %>%
  mutate(from='lowestfscamae')


r2df_all=data_frame()
pctmaedf_all=data_frame()
pctbiasdf_all=data_frame()
irow=1
for(irow in seq_len(nrow(fscamae_stats))){
r2df <-
  fscamae_stats[irow,] %>%
  select(-pctbias,-pctmae,-mdlyr) %>%
  spread(from,r2) %>%
  mutate(errorvar='r2')
r2df_all=bind_rows(r2df_all,r2df)

pctmaedf <-
  fscamae_stats[irow,] %>%
  select(-r2,-pctbias,-mdlyr) %>%
  spread(from,pctmae) %>%
  mutate(errorvar='pctmae')
pctmaedf_all=bind_rows(pctmaedf_all,pctmaedf)

pctbiasdf <-
  fscamae_stats[irow,] %>%
  select(-r2,-pctmae,-mdlyr) %>%
  spread(from,pctbias) %>%
  mutate(errorvar='pctbias')
pctbiasdf_all=bind_rows(pctbiasdf_all,pctbiasdf)
}

## ------ this block I was trying to see if there was a way to identify outlier fscamae datapoints by predicting swe for several of the lowest fscamae dates and comparing cvswe
# phvfsca_data <- 
#   phvfsca %>%
#   mutate(mdlyr=substr(mdldte,1,4),
#          simyr=substr(simdte,1,4)) %>%
#   filter(simyr!=mdlyr) %>% 
#   group_by(simdte,mdldte) %>% 
#   nest()
# 
# outlierCheck=function(cvswe,avgcv,secv){
#    print(cvswe)
#   # print(avgcv)
#   if(cvswe>(avgcv+secv) | cvswe<(avgcv-secv)) return(TRUE)
# }
# inner_join(pctmaedf_all %>% filter(mdlpreds=='phvfsca'),phvfsca_data,by=c('simdte','mdldte')) %>% 
#   group_by(simdte,mdldte,mdlpreds) %>% 
#   mutate(cvswe=map_dbl(data,function(dF){sd(dF$swehat,na.rm=T)/mean(dF$swehat,na.rm=T)}),
#          avgswe=map_dbl(data,function(dF){mean(dF$swehat,na.rm=T)})) %>% 
#   select(-data) %>% 
#   group_by(simdte) %>%  
#   mutate(avgcv=mean(cvswe),
#          secv=sd(avgswe)) %>% 
#   group_by(simdte,mdldte,mdlpreds) %>% 
#   mutate(outlier=ifelse(isTRUE(outlierCheck(cvswe,avgcv,secv)),TRUE,FALSE)
# ) %>% View
## ------

best <-
  bind_rows(
lapply(mylist,function(lst){
  errorvar=lst[[2]]
  mdldF=lst[[1]]
  unnest_(mdldF,as.name(errorvar),.drop=T) %>%
    mutate(from='bestpred')  %>%
    spread_('from',errorvar) %>%
    mutate(errorvar=errorvar)
})
) %>% select(-mdlyr,-mdldte)


diff_df <-
  full_join(bind_rows(r2df_all,pctmaedf_all,pctbiasdf_all),best) %>%
  mutate(diff=lowestfscamae-bestpred) %>%
  gather(var,val,bestpred,lowestfscamae,diff) %>%
  mutate(valtype=ifelse(var=='diff','diff','val'))
```

## summarise selected real-time model performance

```{r summary_realtime}
rt_preds <- left_join(combo2predict,phvfscastats)
  
rt_preds %>% 
  ungroup %>% 
  summarise(
    mean(r2),
    mean(predmae),
    mean(rmse),
    mean(pctmae),
    mean(pctbias)
  ) %>% 
  kable(.,digits=2,
        caption='realtime model summary phvfsca')

rt_preds %>% 
  group_by(simyr) %>% 
summarise(
    mean(r2),
    mean(predmae),
    mean(rmse),
    mean(pctmae),
    mean(pctbias)
  ) %>% 
  kable(.,digits=2,
        caption='realtime model summary phvfsca by year')
  

```

```{r compare_phvfsca-phvasofsca}
pmsp <- diff_df %>% filter(mdlpreds=='phvfsca'|mdlpreds=='phvasofsca',valtype=='diff',errorvar=='pctmae') %>% spread(mdlpreds,val)

pmsp %>% 
  mutate(bettermp=ifelse(phvfsca>phvasofsca,0,1),
         pfgt10=ifelse(phvfsca>10,1,0),
         pafgt10=ifelse(phvasofsca>10,1,0)) %>% 
  group_by(errorvar) %>% 
  summarise(
    sum(bettermp),
    sum(pfgt10),
    sum(pafgt10)
  )


pbsp <- diff_df %>% filter(mdlpreds=='phvfsca' | mdlpreds=='phvasofsca',valtype=='diff',errorvar=='pctbias') %>% spread(mdlpreds,val)

View(pbsp)
pbsp %>% 
  mutate(bettermp=ifelse(phvfsca>phvasofsca,0,1),
         pfgt10=ifelse(phvfsca>10,1,0),
         pafgt10=ifelse(phvasofsca>10,1,0)) %>% 
  group_by(errorvar) %>% 
  summarise(
    sum(bettermp),
    sum(pfgt10),
    sum(pafgt10)
  )



```

```{r plot_compare, results='asis', fig.width=24}
makeplot_fun=function(mdlpreds,errorvar,valtype,data){
  mytitle=function(mdlpreds){
    if(mdlpreds=='phv') myt='PHV'
    if(mdlpreds=='phvfsca') myt='PHV-FSCA'
    if(mdlpreds=='phvaso') myt='PHV-ASO'
    if(mdlpreds=='phvasofsca') myt='PHV-ASO-FSCA'
    return(myt)
  }
  yesGuide=FALSE

  if(valtype=='diff'){
    if(errorvar=='r2')  {
      ycoord=coord_cartesian(ylim=c(-0.21,0))
      # yscale=scale_y_continuous(trans='reverse')
      ax=theme(axis.line.x=element_line())#element_blank())
    }
    if(errorvar=='pctmae')  {
      ycoord=coord_cartesian(ylim=c(0,200))
      ax=theme(axis.line.x=element_line())
    }

    data %>%
      ggplot()+
      geom_point(aes(x=simdte,y=val))+
      ycoord+
      facet_grid(~simyr,scales='free_x')+
      labs(x='Simulation Date',
           y=expression(Delta),
           title=''
      )+
      theme(axis.title.x=element_text(),
            axis.text.x=element_text(angle=45,hjust=1),
            strip.text=element_blank(),
            strip.background=element_blank(),
            plot.title=element_blank(),
            panel.background=element_rect(),
            panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
            plot.margin=unit(c(0,7,7,7),'pt')
      )+
      ax

  } else if(valtype=='val'){
    if(errorvar=='r2') {
      if(mdlpreds=='phv') yesGuide=TRUE
      errlab='r^2'
      yscale=scale_y_continuous()
      ycoord=coord_cartesian(ylim=c(0,1))
    } else {
      errlab='"%"*MAE'
      yscale=scale_y_log10(breaks=c(1,10,100),labels=c(1,10,100))
      ycoord=coord_cartesian()#ylim=c(0.01,500))
}
    errlab=parse(text = paste0(errlab,'~of~prediction'))

  data %>%
    ggplot()+
    geom_point(aes(x=simdte,y=val,colour=var,size=var),show.legend=yesGuide)+
    guides(size='none',colour=guide_legend(''))+
    facet_grid(~simyr,scales='free_x')+
    scale_size_manual(values=c(1.2,1))+
    scale_colour_manual(values=c('blue','red'),labels=c('Best Prediction','Lowest FSCA MAE Prediction'))+
    yscale+
    ycoord+
    labs(x='',
         y=errlab,
         title=mytitle(mdlpreds)
    )+
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          strip.text=element_text(face='bold'),
          strip.background=element_rect(fill=NA,color='black'),
          panel.background=element_rect(),
          panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=0.5),
          plot.title=element_text(face='bold',size=18),
          plot.margin=unit(c(7,7,0,7),'pt'),
          legend.justification = c(0,1),
          legend.position = c(0.02,0.995),
          legend.background = element_rect(fill='white')
    )
  }
}

plist <-
  diff_df %>%
  group_by(mdlpreds,errorvar,valtype) %>%
  nest() %>%
  arrange(errorvar,mdlpreds) %>%
  mutate(gg=pmap(list(mdlpreds,errorvar,valtype,data),makeplot_fun))
gglist=plist$gg

phv_pctmae <- plot_grid(gglist[[1]],
                        gglist[[2]],
                        nrow=2,
                        rel_heights = c(1,.4),
                        align='v')
phvaso_pctmae <- plot_grid(gglist[[3]],
                        gglist[[4]],
                        nrow=2,
                        rel_heights = c(1,.4),
                        align='v')
phvasofsca_pctmae <- plot_grid(gglist[[5]],
                        gglist[[6]],
                        nrow=2,
                        rel_heights = c(1,.4),
                        align='v')
phvfsca_pctmae <- plot_grid(gglist[[7]],
                        gglist[[8]],
                        nrow=2,
                        rel_heights = c(1,.4),
                        align='v')
phv_r2 <- plot_grid(gglist[[9]],
                        gglist[[10]],
                        nrow=2,
                        rel_heights = c(1,.4),
                        align='v')
phvaso_r2 <- plot_grid(gglist[[11]],
                        gglist[[12]],
                        nrow=2,
                        rel_heights = c(1,.4),
                        align='v')
phvasofsca_r2 <- plot_grid(gglist[[13]],
                        gglist[[14]],
                        nrow=2,
                        rel_heights = c(1,.4),
                        align='v')
phvfsca_r2 <- plot_grid(gglist[[15]],
                        gglist[[16]],
                        nrow=2,
                        rel_heights = c(1,.4),
                        align='v')

r2plots <- plot_grid(phv_r2,phvfsca_r2,phvaso_r2,phvasofsca_r2,nrow=1,ncol=4)
pctmaeplots <- plot_grid(phv_pctmae,phvfsca_pctmae,phvaso_pctmae,phvasofsca_pctmae,nrow=1,ncol=4)
allplots <- plot_grid(r2plots,pctmaeplots,nrow=2,ncol=1,labels='auto',label_size=36)
allplots
save_plot(allplots,filename='figs/xdate_prederr_comparison.eps',
          nrow=4,
          ncol=4,
          base_width=8)



```

```{r plot_comparediff, results='asis', fig.width=24}
makeplot_diffonly=function(mdlpreds,errorvar,valtype,data){
  # print(paste('1:',mdlpreds))
  mytitle=function(mdlpreds){
    # print(mdlpreds)
    if(mdlpreds=='phv') myt='PHV'
    if(mdlpreds=='phvfsca') myt='PHV-FSCA'
    if(mdlpreds=='phvaso') myt='PHV-ASO'
    if(mdlpreds=='phvasofsca') myt='PHV-ASO-FSCA'
    return(myt)
  }
  yesGuide=FALSE
  axtheme <- theme()
  if(mdlpreds!='phv' & mdlpreds!='phvaso') {
    axtheme <- theme(axis.text.y=element_blank(),
                     axis.title.y=element_blank(),
                     axis.ticks.y=element_blank()
                     # axis.line.y=element_blank(),

    )
  }
      if(errorvar=='r2')  {
      ycoord=coord_cartesian(ylim=c(-0.21,0))
      # yscale=scale_y_continuous(trans='reverse')
      errlab='Delta*r^2'
    }
    if(errorvar=='pctmae')  {
      errlab='Delta*"%"*MAE'
      ycoord=coord_cartesian(ylim=c(0,200))
    }
  if(errorvar=='pctbias')  {
      errlab='Delta*"%"*Bias'
      ycoord=coord_cartesian(ylim=c(-250,250))
    }
    ylabel=parse(text=errlab)
    data %>%
      ggplot()+
      geom_bar(aes(x=simdte,y=val),stat='identity',position='dodge')+
      ycoord+
      facet_grid(~simyr,scales='free_x')+
      labs(x='Simulation Date',
           y=ylabel,
           title=mytitle(mdlpreds)
      )+
      theme(axis.title.x=element_text(),
            axis.text.x=element_text(angle=90,vjust=.5),
            strip.text=element_text(face='bold'),
            strip.background=element_blank(),
            plot.title=element_text(face='bold',size=14),
            panel.background=element_rect(),
            panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
            plot.margin=unit(c(7,7,7,0),'pt')
      )+
      axtheme
}

plist2 <-
  diff_df %>%
  filter(valtype=='diff') %>%
  mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca'))) %>%
  group_by(mdlpreds,errorvar,valtype) %>%
  nest() %>%
  arrange(desc(errorvar),mdlpreds) %>%
  mutate(gg=pmap(list(as.character(mdlpreds),errorvar,valtype,data),makeplot_diffonly))
gglist=plist2$gg

r2pg <- plot_grid(plotlist=gglist[1:4],nrow=2,align='h')
pmpg <- plot_grid(plotlist=gglist[5:8],nrow=2,align='h')
pbpg <- plot_grid(plotlist=gglist[9:12],nrow=2,align='h')
pg2 <- plot_grid(r2pg,pmpg,pbpg,nrow=3,align='h',labels='auto',label_size=24)
save_plot(pg2,filename='figs/xdate_prederr_diffonly_vertical2.eps',
nrow=6,
ncol=2,
base_width=8,
base_aspect_ratio = .9)



diff_df %>%
  filter(valtype=='diff',errorvar=='r2') %>%
  group_by(mdlpreds,var) %>%
  summarise(mean(val),
            sd(val)) %>%
  kable(digits=2,
        caption='summary stats for differences between r2 of bestpreds and lowestfscamae pred')

diff_df %>%
  filter(valtype=='val',errorvar=='r2') %>%
  group_by(errorvar,mdlpreds,var) %>%
  summarise(mean(val,na.rm=T),
            sd(val,na.rm=T)) %>%
  kable(digits=2,
        caption='summary stats of r2 for different modeltypes')

```

```{r combine_comparediff-pctmae_pctbiasboxplots}
pfplot <- 
  diff_df %>%
  filter(valtype=='diff',mdlpreds=='phvfsca',errorvar=='pctmae') %>%
  ggplot()+
  geom_bar(aes(x=simdte,y=val),stat='identity',position='dodge')+
  coord_cartesian(ylim=c(0,250))+
  scale_y_continuous(breaks=seq(0,250,50),labels=sprintf('%4s',seq(0,250,50)))+
  facet_grid(~simyr,scales='free_x')+
  labs(x='Simulation Date',
       y=expression(Delta*"%"*MAE),
       title='PHV-FSCA'
  )+
  guides(color='none')+
  theme_cowplot(font_size=16)+
  theme(axis.title.x=element_text(),
        axis.text.x=element_text(angle=45,hjust=1,size=14),
        strip.text=element_text(face='bold'),
        strip.background=element_blank(),
        plot.title=element_text(face='bold',size=18),
        panel.background=element_rect(),
        panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
        plot.margin=unit(c(7,7,7,7),'pt')
  )
  
pafplot <- 
  diff_df %>%
  filter(valtype=='diff',mdlpreds=='phvasofsca',errorvar=='pctmae') %>%
  # mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca'))) %>%
  ggplot()+
  geom_bar(aes(x=simdte,y=val),stat='identity',position='dodge')+
  coord_cartesian(ylim=c(0,250))+
  scale_y_continuous(breaks=seq(0,250,50),labels=sprintf('%4s',seq(0,250,50)))+
  facet_grid(~simyr,scales='free_x')+
  labs(x='Simulation Date',
       y=expression(Delta*"%"*MAE),
       title='PHV-ASO-FSCA'
  )+
  theme_cowplot(font_size=16)+
  theme(axis.title.x=element_text(),
        axis.text.x=element_text(angle=45,hjust=1,size=14),
        strip.text=element_text(face='bold'),
        strip.background=element_blank(),
        plot.title=element_text(face='bold',size=18),
        panel.background=element_rect(),
        panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
        plot.margin=unit(c(7,7,7,7),'pt')
  )



pfplot2 <- 
  diff_df %>%
  filter(valtype=='diff',mdlpreds=='phvfsca',errorvar=='pctbias') %>%
  ggplot()+
  geom_bar(aes(x=simdte,y=val),stat='identity',position='dodge')+
  coord_cartesian(ylim=c(-100,250))+
  scale_y_continuous(breaks=seq(-100,250,50),labels=sprintf('%4s',seq(-100,250,50)))+
  facet_grid(~simyr,scales='free_x')+
  labs(x='Simulation Date',
       y=expression(Delta*"%"*Bias),
       title='PHV-FSCA'
  )+
  guides(color='none')+
  theme_cowplot(font_size=16)+
  theme(axis.title.x=element_text(),
        axis.text.x=element_text(angle=45,hjust=1,size=14),
        strip.text=element_text(face='bold'),
        strip.background=element_blank(),
        plot.title=element_text(face='bold',size=18),
        panel.background=element_rect(),
        panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
        plot.margin=unit(c(7,7,7,7),'pt')
  )
  
pafplot2 <- 
  diff_df %>%
  filter(valtype=='diff',mdlpreds=='phvasofsca',errorvar=='pctbias') %>%
  # mutate(mdlpreds=factor(mdlpreds,levels=c('phv','phvfsca','phvaso','phvasofsca'))) %>%
  ggplot()+
  geom_bar(aes(x=simdte,y=val),stat='identity',position='dodge')+
  coord_cartesian(ylim=c(-100,250))+
  scale_y_continuous(breaks=seq(-100,250,50),labels=sprintf('%4s',seq(-100,250,50)))+
  facet_grid(~simyr,scales='free_x')+
  labs(x='Simulation Date',
       y=expression(Delta*"%"*Bias),
       title='PHV-ASO-FSCA'
  )+
  theme_cowplot(font_size=16)+
  theme(axis.title.x=element_text(),
        axis.text.x=element_text(angle=45,hjust=1,size=14),
        strip.text=element_text(face='bold'),
        strip.background=element_blank(),
        plot.title=element_text(face='bold',size=18),
        panel.background=element_rect(),
        panel.border=element_rect(fill=NA,color='grey50',linetype='solid',size=.5),
        plot.margin=unit(c(7,7,7,7),'pt')
  )

topax=theme(axis.text.x=element_blank(),
            axis.ticks.x=element_blank(),
            axis.title.x=element_blank(),
            plot.margin=unit(c(7,7,0,7),'pt'))
col1row1 <- plot_grid(pfplot+topax+ggtitle('PHV-FSCA'),pfplot2,
                      nrow=2,
                      rel_heights = c(.6,.8),
                      align='v',
                      labels='auto',
                      label_size=20)
col2row1 <- plot_grid(pafplot+topax+ggtitle('PHV-ASO-FSCA'),pafplot2,
                      nrow=2,
                      rel_heights = c(.6,.8),
                      align='v')
                      
diffpg <- plot_grid(col1row1,col2row1,ncol=2, align='hv')
save_plot(diffpg,
          filename='figs/prederror_diffbars_best-vs-lowestfscame.pdf',
          base_width = 10,
          base_aspect_ratio = 2,
          nrow=2,
          ncol=2)
```


```{r pctmaecompare, results='asis', fig.height=6}

diff_df %>%
  filter(valtype=='diff',errorvar=='pctmae') %>%
  group_by(mdlpreds,var) %>%
  summarise(mean(val),
            sd(val)) %>%
  kable(digits=2,
        caption='summary stats for differences between pctmae of bestpreds and lowestfscamae pred')

diff_df %>%
  filter(valtype=='val',errorvar=='pctmae') %>%
  group_by(errorvar,mdlpreds,var) %>%
  summarise(mean(val,na.rm=T),
            sd(val,na.rm=T)) %>%
  kable(digits=2,
        caption='summary stats for pctmae different modeltypes')

#   ggplot()+
#     geom_bar(aes(x=simdte,y=val),stat='identity',position='dodge')+
#     coord_cartesian(ylim=c(0,-200))

```

```{r pctbiascompare, results='asis', fig.height=6}

diff_df %>%
  filter(valtype=='diff',errorvar=='pctbias') %>%
  group_by(mdlpreds,var) %>%
  summarise(mean(val),
            sd(val)) %>%
  kable(digits=2,
        caption='summary stats for differences between pctbias of bestpreds and lowestfscamae pred')

diff_df %>%
  filter(valtype=='val',errorvar=='pctbias') %>%
  group_by(errorvar,mdlpreds,var) %>%
  summarise(mean(val,na.rm=T),
            sd(val,na.rm=T)) %>%
  kable(digits=2,
        caption='summary stats for pctbias different modeltypes')

#   ggplot()+
#     geom_bar(aes(x=simdte,y=val),stat='identity',position='dodge')+
#     coord_cartesian(ylim=c(0,-200))

```

# swe and fsca difference for best predictions

More yellow means prediction was better. x and y axis represent the differences between simulation date and model date expressed as mean squared error or mean absolute error.

Again not that useful to look at because prediction error is lowest when fscamae is highest (due to more snow cover earlier in season). Not immediately intuitive until you look at fscamae vs date.

```{r eval=F}
pltdata <-
  bind_rows(
    lapply(mylist,FUN=function(lst){
      dF=lst[[1]]
      errorvar=lst[[2]]
      errordF <- unnest_(dF,as.name(errorvar),.drop=T) %>%
        gather_("prederrorvar","prederror",errorvar)
      left_join(errordF,snow_stats)
    })
  )

plot_swefscadiff=function(dF){
  mytitle=paste(unique(dF$mdlpreds),unique(dF$prederrorvar))
  my_y=paste('swe',unique(dF$diffmetric))
  my_x=paste('fsca',unique(dF$diffmetric))
  if(unique(dF$prederrorvar)=='pctmae') colpaldir=-1 else colpaldir=1
  ggplot(dF,aes(x=fsca,y=swe,color=prederror))+
    geom_abline()+
    geom_point(size=2)+
    geom_smooth(method='lm',color='grey50',linetype=2,se=F)+
    labs(title=mytitle,x=my_x,y=my_y)+
    # coord_equal()+
    # facet_grid(diffmetric~prederrorvar)+
    scale_color_viridis(direction=colpaldir)
}

tt=pltdata %>%
  split(list(.$mdlpreds,.$diffmetric,.$prederrorvar)) %>%
  map(plot_swefscadiff)
plot_grid(plotlist = tt, align='hv',ncol=4, labels=paste0('(',seq_len(length(tt)),')'))

```

```{r table_fscadiff-snowdiff,results='asis', eval=F}
bestfitlines <-
  pltdata %>%
  split(list(.$mdlpreds,.$diffmetric,.$prederrorvar)) %>%
  map(~lm(swe~fsca,data=.))

mdllabs <- paste(rep(c('phv','phvfsca','phvaso','phvasofsca'),each=2),rep(c('r2','pctmae'),each=1),sep='.')

stargazer(bestfitlines,
          type='html',
          flip=F,
          # covariate.labels=rep(c('fscadiff',),length.out=16),
          # dep.var.labels = mdllabs,
          # column.labels=paste0(rep(seq(1,8),each=2),c('a','s')),
          keep.stat=c('rsq'),
          digits=2,
          report=c('vc*'),
          no.space=F,
          out='output/table_snowmetrics-fscametrics-prederror.html')

```
